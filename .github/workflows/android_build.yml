name: Build and Sign Quantum NARCAN APK (Ephemeral Key)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ephemeral-apk:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git zip unzip openjdk-11-jdk \
          libncurses6 libstdc++6 libffi-dev libssl-dev \
          libsqlite3-dev zlib1g-dev libjpeg-dev libfreetype6-dev

    - name: âš™ï¸ Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython

    - name: ğŸ”§ Initialize Buildozer and configure spec
      run: |
        buildozer init

        sed -i 's/^# *source.include_patterns.*/source.include_patterns = narcan_finder_android.py/' buildozer.spec
        sed -i 's/^# *title.*/title = Quantum NARCAN Finder/' buildozer.spec
        sed -i 's/^# *package.name.*/package.name = QuantumNarcan/' buildozer.spec
        sed -i 's/^# *package.domain.*/package.domain = org.quantum.narcan/' buildozer.spec
        sed -i 's/^requirements.*/requirements = kivy, kivymd, httpx, numpy, psutil, cryptography, sqlite3, pennylane/' buildozer.spec

        grep -q '^android.permissions' buildozer.spec && \
          sed -i 's/^android.permissions.*/android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE/' buildozer.spec || \
          echo 'android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE' >> buildozer.spec

        grep -q '^log_level' buildozer.spec && \
          sed -i 's/^log_level.*/log_level = 2/' buildozer.spec || \
          echo 'log_level = 2' >> buildozer.spec

        echo "android.release_artifact = true" >> buildozer.spec

    - name: ğŸ“¥ Install Android SDK components manually
      run: |
        yes | buildozer android update

    - name: ğŸ” Generate ephemeral keystore
      run: |
        keytool -genkey -v -keystore quantum_temp.keystore \
          -alias quantumalias \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass testpass -keypass testpass \
          -dname "CN=QuantumNarcan,O=OpenAI,L=Greenville,ST=SC,C=US"

    - name: ğŸ§ª Build Release APK (avoid Broken Pipe)
      run: |
        timeout 30m stdbuf -oL -eL buildozer android release | tee buildozer_output.log

    - name: ğŸ” Sign APK with ephemeral keystore
      run: |
        jarsigner -verbose \
          -sigalg SHA1withRSA -digestalg SHA1 \
          -keystore quantum_temp.keystore \
          -storepass testpass -keypass testpass \
          bin/QuantumNarcan-release-unsigned.apk \
          quantumalias

    - name: ğŸ§© Zipalign APK
      run: |
        wget https://dl.google.com/android/repository/build-tools_r30.0.3-linux.zip
        unzip -q build-tools_r30.0.3-linux.zip -d android-tools
        chmod +x android-tools/**/zipalign
        android-tools/**/zipalign -v 4 \
          bin/QuantumNarcan-release-unsigned.apk \
          bin/QuantumNarcan-release-signed.apk

    - name: ğŸ“¤ Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: quantum-narcan-signed-ephemeral
        path: bin/QuantumNarcan-release-signed.apk
