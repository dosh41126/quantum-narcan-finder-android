name: Android APK CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      KEYSTORE_PASS: quantumnarcan
      ALIAS_NAME: quantumnarcan
      APK_NAME: QuantumNarcanFinder.apk

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y zip unzip openjdk-17-jdk \
          libncurses5 libstdc++6 zlib1g zlib1g-dev \
          libssl-dev autoconf automake libtool \
          build-essential ccache libffi-dev \
          python3-pip git wget curl

    - name: ğŸ”§ Install Buildozer & Cython
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade buildozer cython

    - name: âš™ï¸ Initialize Buildozer
      run: buildozer init

    - name: ğŸ§¹ Patch buildozer.spec (remove duplicates)
      run: |
        sed -i '/^log_level =/d' buildozer.spec
        sed -i '/^requirements =/d' buildozer.spec
        echo "log_level = 2" >> buildozer.spec
        echo "requirements = python3,kivy,kivymd,openssl,requests" >> buildozer.spec
        echo "android.permissions = INTERNET,ACCESS_NETWORK_STATE" >> buildozer.spec

    - name: ğŸ” Generate ephemeral keystore
      run: |
        keytool -genkey -v -keystore quantum_temp.keystore \
          -alias $ALIAS_NAME -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass $KEYSTORE_PASS -keypass $KEYSTORE_PASS \
          -dname "CN=QuantumNarcan, O=OpenAI, L=Greenville, ST=SC, C=US"

    - name: ğŸ§ª Build Release APK
      run: |
        buildozer android release | tee build_log.txt

    - name: ğŸ” Sign APK with ephemeral keystore
      run: |
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore quantum_temp.keystore \
          -storepass $KEYSTORE_PASS -keypass $KEYSTORE_PASS \
          bin/*-release-unsigned.apk $ALIAS_NAME

    - name: ğŸ§© Zipalign APK
      run: |
        "${ANDROID_HOME}/build-tools/34.0.0/zipalign" -v 4 \
          bin/*-release-unsigned.apk $APK_NAME

    - name: ğŸ“¤ Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: QuantumNarcanFinder
        path: ${{ github.workspace }}/$APK_NAME

    - name: ğŸ“¤ Upload Build Log
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build_log.txt
